{% extends 'base.html' %}
{% load static %}

{% block css %}
<link href="{% static 'css/games.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}{{ object.title }} ‚Äî Joystick Juice{% endblock %}

{% block content %}
<div class="game-container">

  <div class="game-top">
    <!-- coluna esquerda: cover + a√ß√µes -->
    <div class="left-col">
      <div class="cover-wrap">
        <img src="{{ object.cover_url }}" alt="{{ object.title }}" class="cover-img">
      </div>

      <div class="painel-acoes" aria-label="A√ß√µes do jogo">
        <div class="botoes-rapidos" role="toolbar" aria-label="A√ß√µes r√°pidas">
          <button class="acao" type="button">üëÅ Assistir</button>
          <button class="acao" type="button">‚ù§Ô∏è Curtir</button>

          <!-- Bot√£o de Lista com Modal -->
          {% if user.is_authenticated %}
          <button class="acao" type="button" data-bs-toggle="modal" data-bs-target="#gameListModal{{ object.pk }}">
            üìå Lista
          </button>
          {% endif %}
        </div>

        <div class="avaliar" aria-label="Avaliar">
          <p style="margin:0;color:var(--muted);font-weight:600">Avaliar</p>
          <div class="estrelas" id="estrelas" role="radiogroup" aria-label="Estrelas de avalia√ß√£o">
            <span data-valor="1" role="radio" aria-checked="false">‚òÖ</span>
            <span data-valor="2" role="radio" aria-checked="false">‚òÖ</span>
            <span data-valor="3" role="radio" aria-checked="false">‚òÖ</span>
            <span data-valor="4" role="radio" aria-checked="false">‚òÖ</span>
            <span data-valor="5" role="radio" aria-checked="false">‚òÖ</span>
          </div>
          <p id="nota-escolhida">Sem avalia√ß√£o</p>
        </div>
      </div>
    </div>

    <!-- coluna direita: t√≠tulo, descri√ß√£o, tags -->
    <div class="meta right-col">
      <h1 class="jogao">{{ object.title }}</h1>

      {% if object.trailer_url %}
      <div class="game-trailer my-4">
        <div class="video-wrap" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;">
          <iframe src="{{ object.trailer_url }}"
                  title="Trailer de {{ object.title }}"
                  style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
          </iframe>
        </div>
      </div>
      {% endif %}

      <div class="submeta">
        <span class="tags">G√™nero: {{ object.genre }}</span>
        <span class="tags">Lan√ßamento: {{ object.release_date }}</span>
      </div>

      <p class="descricao">{{ object.synopsis }}</p>

      <div class="tag">
        <span class="tags">Plataforma: {{ object.platforms|default:"‚Äî" }}</span>
        {% if object.developer %}<span class="tags">Desenvolvedor: {{ object.developer }}</span>{% endif %}
      </div>
    </div>
  </div>
<!-- Modal de Games estilizado como Perfil -->
{% if user.is_authenticated %}
<div class="modal fade game-management-modal" id="gameListModal{{ object.pk }}" tabindex="-1" aria-labelledby="gameListModalLabel{{ object.pk }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content game-management-content">
      <form method="POST" action="{% url 'update_game_status' object.pk %}">
        {% csrf_token %}
        <div class="modal-header game-management-header">
          <h5 class="modal-title game-management-title w-100 text-center" id="gameListModalLabel{{ object.pk }}">Gerenciar lista de jogos</h5>
          <button type="button" class="btn-close game-management-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body game-management-body">
          <div class="game-status-control">
            <label for="status{{ object.pk }}" class="game-status-label">Status do Jogo</label>
            <select name="status" id="status{{ object.pk }}" class="game-status-select">
              <option value="J" {% if user_status == "J" %}selected{% endif %}>Jogando</option>
              <option value="C" {% if user_status == "C" %}selected{% endif %}>Conclu√≠do</option>
              <option value="A" {% if user_status == "A" %}selected{% endif %}>Abandonado</option>
              <option value="P" {% if user_status == "P" or not user_status %}selected{% endif %}>Para Jogar</option>
            </select>
          </div>
        </div>

        <div class="modal-footer game-management-footer">
          {% if in_list %}
            <button type="submit" class="btn btn-status-update">Atualizar status</button>
            <a href="{% url 'remove_from_list' object.pk %}" class="btn btn-remove-game">Remover da lista</a>
          {% else %}
            <button type="button" class="btn btn-cancel-action" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-add-game">Adicionar √† lista</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

  <!-- Avalia√ß√µes -->
  <h2 class="avlctitulo">Avalia√ß√µes</h2>

  <div class="avaliacao-container">
    <div class="avaliacao" aria-hidden="false">
      <div class="chart-container" id="chart"></div>
    </div>

    <aside class="side-stats" aria-label="Estat√≠sticas">
      <h4>M√©dia geral</h4>
      <div class="stat-row"><strong style="font-size:20px">4.2</strong><span class="muted">/ 5</span></div>
      <div style="height:8px"></div>
      <h4>Total de votos</h4>
      <div class="stat-row"><span>{{ total_votes|default:"420" }}</span></div>
      <div style="height:10px"></div>
      <h4>Distribui√ß√£o</h4>
      <div style="font-size:13px;color:var(--muted)">Passe o mouse sobre uma barra para ver detalhe</div>
    </aside>
  </div>

 <h2>Coment√°rios</h2>

{% for review in reviews %}
    <h4>Coment√°rios da review #{{ review.reviewID }}</h4>

    {% if review.comments.all %}
        {% for comment in review.comments.all %}
            <p><strong>{{ comment.user.username }}</strong>: {{ comment.opinion }}</p>
        {% endfor %}
    {% else %}
        <p>Seja o primeiro a comentar!</p>
    {% endif %}

    {% if user.is_authenticated %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="hidden" name="review_id" value="{{ review.pk }}">
        <button type="submit">Comentar</button>
    </form>
    {% else %}
        <p><em>Fa√ßa login para comentar.</em></p>
    {% endif %}

{% endfor %}

</div>

<script>
  // gr√°fico de votos
  const votos = {
    "0.5": 5,"1.0": 8,"1.5": 12,"2.0": 18,"2.5": 30,
    "3.0": 45,"3.5": 60,"4.0": 80,"4.5": 95,"5.0": 80
  };

  const valores = ["0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0"];
  const total = Object.values(votos).reduce((a,b) => a + b, 0);
  const maxCount = Math.max(...Object.values(votos));
  const chart = document.getElementById('chart');

  chart.innerHTML = '';
  valores.forEach(valStr => {
    const count = votos[valStr] || 0;
    const percent = total ? Math.round((count / total) * 100) : 0;
    const height = maxCount ? (count / maxCount) * 140 : 0;

    const col = document.createElement('div');
    col.className = 'bar-column';

    const displayVal = Number(valStr).toFixed(1).replace('.', ',');

    const bar = document.createElement('div');
    bar.className = 'bar-fill';
    bar.style.height = height + 'px';

    const ratingBox = document.createElement('div');
    ratingBox.className = 'rating-table';
    ratingBox.innerHTML = `
      <table>
        <thead>
          <tr><th>Nota</th><th>Detalhe</th></tr>
        </thead>
        <tbody>
          <tr><td>${displayVal}</td><td>Votos: ${count}</td></tr>
          <tr><td>%</td><td>${percent}%</td></tr>
          <tr><td>Total</td><td>${total}</td></tr>
        </tbody>
      </table>
    `;

    col.appendChild(bar);
    col.appendChild(ratingBox);
    chart.appendChild(col);
  });

  // estrelas
  const estrelas = document.querySelectorAll('#estrelas span');
  const saida = document.getElementById('nota-escolhida');
  estrelas.forEach(e => {
    e.addEventListener('click', () => {
      const nota = e.dataset.valor;
      estrelas.forEach(s => s.classList.remove('ativo'));
      for (let i = 0; i < nota; i++) estrelas[i].classList.add('ativo');
      saida.textContent = `Voc√™ avaliou com ${nota} estrela${nota>1?'s':''}`;
      estrelas.forEach(s => s.setAttribute('aria-checked','false'));
      for (let i = 0; i < nota; i++) estrelas[i].setAttribute('aria-checked','true');
    });
  });
</script>
{% endblock %}
